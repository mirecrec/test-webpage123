<!DOCTYPE html>
<html lang="sk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Stopky + GPS (MVP)</title>
  <style>
    body { margin: 0; background: #0b0f14; color: #e7eef6; font-family: system-ui, sans-serif; }
    .wrap { max-width: 640px; margin: 0 auto; padding: 16px; }
    .card { background: #121822; border-radius: 12px; padding: 16px; margin: 12px 0; }
    input, button { width: 100%; padding: 10px; margin-top: 4px; border-radius: 8px; border: none; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .btns { display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap; }
    button { background-color: #1a2533; color: white; }
    button.primary { background-color: #1e804f; }
    button.warn { background-color: #7a1b21; }
    .pill, .mono { font-family: monospace; }
    .log { background: #0f141c; border: 1px dashed #2b3b51; border-radius: 12px; padding: 12px; max-height: 240px; overflow: auto; white-space: pre-wrap; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>‚è±Ô∏è Stopky + üìçGPS (MVP)</h1>

    <!-- Nastavenia merania -->
    <div class="card">
      <div class="row">
        <div>
          <label>Pl√°novan√Ω ≈°tart (voliteƒæn√©)</label>
          <input id="startTime" type="datetime-local" />
        </div>
        <div>
          <label>Auto-stop polomer (m)</label>
          <input id="autoStop" type="number" value="25" />
        </div>
      </div>
      <div class="row">
        <div>
          <label>Cieƒæ ‚Äì ≈°√≠rka (lat)</label>
          <input id="lat" type="number" step="any" placeholder="48.1486" />
        </div>
        <div>
          <label>Cieƒæ ‚Äì dƒ∫≈æka (lon)</label>
          <input id="lon" type="number" step="any" placeholder="17.1077" />
        </div>
      </div>
      <div class="row">
        <div>
          <label>Max. povolen√° chyba GPS (m)</label>
          <input id="minAcc" type="number" value="35" />
        </div>
        <div>
          <label>Vzorkovanie (ms)</label>
          <input id="sampling" type="number" value="1000" />
        </div>
      </div>
      <div class="btns">
        <button id="btnStart" class="primary">≈†tart</button>
        <button id="btnStop" class="warn" disabled>Stop</button>
        <button id="btnReset">Reset</button>
        <button id="btnCopy">Kop√≠rova≈• JSON</button>
      </div>
    </div>

    <!-- V√Ωstup a log -->
    <div class="card">
      <p><b>Stav:</b> <span id="status" class="mono">pripraven√©</span></p>
      <p><b>Elapsed:</b> <span id="elapsed" class="mono">00:00.000</span></p>
      <p><b>≈†tart (UTC):</b> <span id="startUTC" class="mono">‚Äî</span></p>
      <p><b>Koniec (UTC):</b> <span id="endUTC" class="mono">‚Äî</span></p>
      <p><b>Poloha:</b> <span id="pos" class="mono">‚Äî</span></p>
      <p><b>Vzdialenos≈• do cieƒæa:</b> <span id="dist" class="mono">‚Äî</span> m <span id="distok"></span></p>
    </div>

    <div class="card">
      <p><b>Log:</b></p>
      <div id="log" class="log"></div>
    </div>
  </div>

  <script>
    const el = id => document.getElementById(id);
    const log = msg => {
      const t = new Date().toISOString();
      el("log").textContent = "[" + t + "] " + msg + "\n" + el("log").textContent;
    };

    const distMeters = (lat1, lon1, lat2, lon2) => {
      const R = 6371000;
      const toRad = d => d * Math.PI / 180;
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    };

    let running = false;
    let startWallUtc = null, startMono = null, endWallUtc = null, endMono = null;
    let watchId = null, timerId = null, trace = [];

    const fmtElapsed = ms => {
      const mm = Math.floor(ms/60000);
      const ss = Math.floor((ms%60000)/1000);
      const ms3 = Math.floor(ms%1000);
      return String(mm).padStart(2,'0')+':'+String(ss).padStart(2,'0')+'.'+String(ms3).padStart(3,'0');
    };

    const onPosition = pos => {
      const c = pos.coords;
      const nowWall = Date.now();
      const nowMono = performance.now();
      el("pos").textContent = `lat:${c.latitude.toFixed(6)}, lon:${c.longitude.toFixed(6)}, acc:${c.accuracy}m`;
      const tgtLat = parseFloat(el("lat").value);
      const tgtLon = parseFloat(el("lon").value);
      if (!isNaN(tgtLat) && !isNaN(tgtLon)) {
        const d = distMeters(c.latitude, c.longitude, tgtLat, tgtLon);
        el("dist").textContent = d.toFixed(1);
        const ok = (d <= Number(el("autoStop").value||25)) && (c.accuracy <= Number(el("minAcc").value||35));
        el("distok").textContent = ok ? "‚úÖ" : "";
        if (running && ok) finish("auto-stop: cieƒæ dosiahnut√Ω");
      }
      if (running) trace.push({t_wall:new Date(nowWall).toISOString(), t_mono:nowMono-startMono, lat:c.latitude, lon:c.longitude, acc:c.accuracy});
    };

    const onError = err => log("GPS chyba: " + err.message);

    const begin = () => {
      if (running) return;
      running = true;
      startWallUtc = Date.now();
      startMono = performance.now();
      trace = [];
      el("startUTC").textContent = new Date(startWallUtc).toISOString();
      el("status").textContent = "be≈æ√≠";
      el("btnStart").disabled = true;
      el("btnStop").disabled = false;
      timerId = setInterval(() => el("elapsed").textContent = fmtElapsed(performance.now() - startMono), 50);
      watchId = navigator.geolocation.watchPosition(onPosition, onError, { enableHighAccuracy: true });
      log("≈†tart");
    };

    const finish = (reason = "manu√°lne Stop") => {
      if (!running) return;
      running = false;
      endWallUtc = Date.now();
      endMono = performance.now();
      el("endUTC").textContent = new Date(endWallUtc).toISOString();
      el("elapsed").textContent = fmtElapsed(endMono - startMono);
      el("status").textContent = "ukonƒçen√©";
      el("btnStart").disabled = false;
      el("btnStop").disabled = true;
      clearInterval(timerId);
      navigator.geolocation.clearWatch(watchId);
      log("Stop: " + reason);
    };

    const resetAll = () => {
      running = false;
      clearInterval(timerId);
      navigator.geolocation.clearWatch(watchId);
      el("elapsed").textContent = "00:00.000";
      el("startUTC").textContent = "‚Äî";
      el("endUTC").textContent = "‚Äî";
      el("status").textContent = "pripraven√©";
      el("btnStart").disabled = false;
      el("btnStop").disabled = true;
      el("log").textContent = "";
      trace = [];
      log("Reset");
    };

    const getPayload = () => ({
      start_wall: new Date(startWallUtc).toISOString(),
      end_wall: new Date(endWallUtc).toISOString(),
      elapsed_ms: Math.round(endMono - startMono),
      samples: trace
    });

    el("btnStart").onclick = () => {
      const dt = el("startTime").value;
      if (dt) {
        const when = new Date(dt).getTime();
        const delay = Math.max(0, when - Date.now());
        log("Napl√°novan√© spustenie o " + Math.round(delay / 1000) + "s");
        setTimeout(begin, delay);
      } else begin();
    };

    el("btnStop").onclick = () => finish("manu√°lne");
    el("btnReset").onclick = resetAll;
    el("btnCopy").onclick = async () => {
      const json = JSON.stringify(getPayload(), null, 2);
      try {
        await navigator.clipboard.writeText(json);
        log("JSON skop√≠rovan√Ω");
      } catch {
        const blob = new Blob([json], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url; a.download = "meranie.json"; a.click();
        URL.revokeObjectURL(url);
        log("Stiahnut√Ω meranie.json");
      }
    };
  </script>
</body>
</html>
